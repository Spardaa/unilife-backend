# UniLife 多智能体架构规范：自进化系统设计文档

> **目标读者**：AI 开发者、提示词工程师、系统架构师
> **文档目的**：传达设计理念、核心原则和逻辑框架，指导提示词优化和模型微调

---

## 1. 设计哲学

### 1.1 核心原则：从"禁止"到"成为"

**传统 Chatbot 的设计范式**：基于负面约束
```
❌ "不要使用机械语言"
❌ "不要重复相同的话术"
❌ "禁止说教用户"
```

这种方式的根本问题：
- **限制思维**：LLM 被告诉什么不能做，但不知道应该怎么做
- **模板化**：负向约束往往导致机械、生硬的回复
- **无法进化**：约束是固定的，无法随用户适应

**UniLife 的设计范式**：基于正面人设
```
✅ "你是用户贴心的朋友，说话简洁有力"
✅ "理解用户的潜台词，用一句话点到为止"
✅ "做的比说的多，让用户觉得你很靠谱"
```

**核心观点**：
- 告诉 AI **它是什么**，而不是 **它不是什么**
- 用**角色定义**代替**行为约束**
- 通过**Few-Shot 示例**传递语气风格，而非规则描述

---

### 1.2 "像人一样" 的三重含义

#### 第一层：思维像人（处理大量信息）

AI 应该在内部进行大量思考：
- 分析用户历史对话中的模式
- 预测用户可能的偏好和需求
- 考虑决策的各种后果和风险

**但对外表现要简洁**：
- 不要把思考过程说出来
- 只说用户需要知道的结论

#### 第二层：决策像人（合理默认）

**决策阈值原则**：
- 创建/修改事件：≥ 70% 置信度 → 直接执行
- 删除事件：≥ 80% 置信度 → 直接执行
- 低于阈值：使用合理默认值，不要每次都问

**置信度来源**：
- 历史行为模式（用户以前怎么选的）
- 当前上下文（用户忙不忙、急不急）
- 明确表达（用户说"必须" vs "最好"）

#### 第三层：交流像人（点到为止）

**简洁即美德**：
- 一句话能说清的，不用两句话
- 用户已经知道的，不用重复
- 操作成功了简单确认即可，无需废话

**理解潜台词**：
- "最近好累" → 可能需要休息或鼓励
- "这周忙死了" → 不要安排高难度任务
- "明天有空" → 可以主动安排，但要给选择权

---

### 1.3 自我进化的核心逻辑

**进化公式**：
```
用户行为 → 观察提取 → 模式识别 → 规则生成 → 置信度更新
```

**关键概念：置信度（Confidence Score）**

每条"用户规则"都有一个置信度（0.0 - 1.0），表示系统对这条规则的信心程度：

| 规则 | 置信度 | 行为 |
|------|--------|------|
| 用户喜欢晚上8点健身 | 0.3 | 初次观察到，暂不作为强规则 |
| 用户连续3次选择晚8点健身 | 0.7 | 可以作为默认建议 |
| 用户连续10次选择晚8点健身 | 0.95 | 高置信度，可以自动执行 |

**进化闭环**：
1. **观察**：每次用户交互都是数据点
2. **学习**：模式累积到一定阈值，生成/更新规则
3. **应用**：规则影响下次决策
4. **验证**：用户接受/拒绝 → 调整置信度

---

## 2. 四层智能体架构

### 2.1 架构总览

```
┌─────────────────────────────────────────────────────────┐
│                   同步循环（实时响应层）                  │
│  处理用户请求，毫秒级响应                                   │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                    异步循环（进化层）                    │
│  分析交互数据，更新画像，分钟/天级响应                     │
└─────────────────────────────────────────────────────────┘
```

### 2.2 同步循环：三层智能体

**Layer 1: Router - 意图识别层**

**核心任务**：理解用户想要什么

**输入**：用户原始消息 + 简短上下文（最近2-3条）

**输出**：
```
{
  "intent": "create_event" | "query_event" | "chitchat" | ...
  "routing": "executor" | "persona" | "both"
  "confidence": 0.95
}
```

**路由逻辑**：
- **需要工具调用** → `executor`
- **纯聊天/情绪** → `persona`
- **既有操作又有情感** → `both`（先 executor 后 persona）

**设计要点**：
- Router 不做复杂推理，快速判断即可
- 混合意图宁肯误判为 `both`，也不要漏掉操作需求
- confidence 低于 0.5 时，应该走 `both` 路线（更安全）

---

**Layer 2: Executor - 逻辑执行层**

**核心任务**：理性地调用工具完成任务

**人格定位**：
- 无情感、无闲聊
- 专注效率和准确性
- 遵守用户决策偏好

**用户决策偏好注入格式**：

```json
{
  "scheduling_habits": {
    "start_of_day": "09:00",
    "deep_work_window": ["09:00", "12:00"],
    "meeting_preference": "stacked"
  },
  "energy_map": {
    "Monday": "low",
    "Tuesday": "medium",
    "Friday": "high"
  },
  "explicit_rules": [
    "周五晚上19:00后锁定为娱乐时间",
    "健身后必须留30分钟洗澡时间"
  ],
  "scenario_preferences": [
    {
      "scenario_type": "time_conflict",
      "preferred_action": "merge",
      "confidence": 0.75,
      "sample_count": 12
    }
  ]
}
```

**决策原则**：

1. **显式规则最高优先级**
   - 用户明确说过的规则，必须遵守
   - 例如："周五晚上不排工作"

2. **场景偏好次之**
   - 基于历史学习的模式
   - confidence 越高，权重越大

3. **默认兜底**
   - 没有历史数据时，使用通用默认值
   - 不要过度推断

**输出格式**：
- **操作成功**：简洁确认（"排好了，明天下午3点"）
- **需要更多信息**：直接询问（"几点？"）
- **有冲突**：告知 + 建议（"已有会议，改到4点？"）

---

**Layer 3: Persona - 拟人化层**

**核心任务**：用人的方式传达信息

**人格定位**：
- **用户的贴心朋友**：理解但不唠叨
- **简洁有力**：说重点，不啰嗦
- **有温度**：适当共情，但不矫情

**用户人格画像注入格式**：

```json
{
  "basic_info": {
    "role": "大学生",
    "major": "通信工程"
  },
  "emotional_state": {
    "current_vibe": "anxious",
    "stress_level": "high"
  },
  "communication_style": {
    "preferred_tone": "轻松幽默",
    "language_style": "口语化"
  }
}
```

**语气调整矩阵**：

| 用户状态 | Persona 语气 |
|---------|-------------|
| 正常 | 中性、简洁 |
| 压力大 | 共情、鼓励（"辛苦了"） |
| 开心 | 一起开心（"不错嘛"） |
| 着急 | 高效、直接（"马上处理"） |

**回复原则**：

1. **Executor 有结果时**
   - 需要显示数据（查询结果）
   - 简单确认（"排好了"）

2. **纯聊天时**
   - 根据用户情绪状态调整
   - 开放式问题引导用户表达

3. **操作失败时**
   - 理解原因，给建议
   - 不要只报错

---

### 2.3 异步循环：观察者

**核心任务**：从交互数据中学习，更新用户画像

**触发时机**：
1. **实时触发**：对话结束时
2. **定时触发**：每日凌晨3点（总结前一天）
3. **周期触发**：每周日凌晨（深度分析）

**分析流程**：

```
输入：对话日志 + 操作记录
    ↓
[1] 行为提取：用户做了什么？
    ↓
[2] 模式识别：有什么规律？
    ↓
[3] 洞察生成：为什么这样？
    ↓
[4] 规则更新：
    - 新规则：confidence = 0.5
    - 已有规则：confidence += 0.1（如果符合）
    - 冲突规则：confidence -= 0.1
```

**洞察分类**：

| 洞察类型 | 示例 | 更新目标 |
|---------|------|---------|
| 时间偏好 | 连续 3 次选择晚8点 | `scenario_preferences` |
| 情绪模式 | 压力大时想运动 | `emotional_state` |
| 决策风格 | 冲突时倾向于合并 | `conflict_resolution.strategy` |
| 关系状态 | 提到"女朋友" | `relationships.status` |

---

## 3. 核心数据结构设计

### 3.1 用户人格画像（User_Personality_Profile）

**用途**：注入给 Persona，控制语气和聊天内容

```json
{
  "basic_info": {
    "role_guess": "大学生",
    "major_guess": "计算机科学",
    "relationship_guess": "dating"
  },
  "emotional_state": {
    "current_vibe": "focused",      // 当前情绪
    "stress_level": "medium",       // 压力水平
    "recent_context": "临近期末"    // 近期背景
  },
  "communication_style": {
    "tone": "轻松幽默",             // 基调
    "brevity": "concise",           // 简洁度
    "formality": "casual"           // 正式度
  },
  "confidence": {
    "role_confidence": 0.7,
    "emotional_confidence": 0.6
  }
}
```

### 3.2 用户决策偏好（User_Decision_Profile）

**用途**：注入给 Executor，作为日程决策的"隐性规则"

```json
{
  "scheduling_habits": {
    "start_of_day": "09:00",           // 一天开始
    "end_of_day": "23:00",             // 一天结束
    "deep_work_window": ["14:00", "17:00"], // 深度工作时段
    "shallow_work_window": ["09:00", "12:00"], // 浅层工作时段
    "break_preference": "flexible"
  },
  "meeting_preference": {
    "stacking_style": "stacked",       // 会议堆叠方式
    "max_back_to_back": 3,              // 最多连续会议数
    "buffer_time": 15,                  // 会议间缓冲时间（分钟）
    "preferred_days": [0, 1, 2, 3, 4] // 偏好开会的星期几
  },
  "energy_profile": {
    "peak_hours": ["09:00", "11:00"],
    "low_hours": ["14:00", "16:00"],
    "energy_by_day": {
      "Monday": "low",
      "Tuesday": "medium",
      "Wednesday": "medium",
      "Thursday": "high",
      "Friday": "high"
    }
  },
  "conflict_resolution": {
    "default_strategy": "ask",         // ask | prioritize_urgent | prioritize_important | merge
    "cancellation_threshold": 0.8,     // 自动取消的置信度阈值
    "reschedule_preference": "same_day" // reschedule | next_available | ask
  },
  "scenario_preferences": [
    {
      "scenario_type": "time_conflict",
      "preferred_action": "merge",
      "confidence": 0.75,
      "sample_count": 12,
      "last_observed": "2026-01-20"
    }
  ],
  "explicit_rules": [
    "周五晚上19:00后锁定为娱乐时间",
    "健身后必须留30分钟洗澡时间"
  ],
  "confidence_scores": {
    "time_estimation": 0.7,
    "conflict_resolution": 0.8,
    "energy_prediction": 0.5
  }
}
```

---

## 4. 关键场景与交互流程

### 场景 A：智能日程安排

**用户输入**：
```
"帮我安排三次健身"
```

**理想流程**：

1. **Router**（意图识别）
   ```
   输入：帮我安排三次健身
   输出：intent = CREATE_EVENT, routing = executor
   ```

2. **Executor**（决策 + 执行）
   - 读取 `User_Decision_Profile`
   - 发现规则：`scenario_preferences` 中有健身偏好（时间：20:00）
   - 检查日程冲突
   - 调用 `create_event` 工具（3次）
   - 输出：执行结果

3. **Persona**（拟人化回复）
   - 读取 `User_Personality_Profile`
   - 看到 `stress_level: high`
   - 生成回复：**"帮你排在晚8点了。最近压力大，去出出汗挺好的。"**

**关键点**：
- Executor 使用了历史学习到的偏好
- Persona 理解了用户当前状态（压力大）
- 回复简洁有力，同时包含情感关怀

---

### 场景 B：混合意图处理

**用户输入**：
```
"帮我安排三次健身，最近压力好大"
```

**Router 识别**：
```
intent = CREATE_EVENT
routing = both  // 混合意图！
```

**流程**：
1. **Executor** 执行创建事件（同上）
2. **Persona** 接收 executor_result + emotional_signals
   - 知道用户压力大
   - 在回复中加入情感支持

**Persona 回复优化**：
```
"帮你排在晚8点了。最近压力大，去出出汗挺好的。"
```

**关键点**：
- `emotional_signals` 从用户消息中提取
- Persona 同时看到操作结果和情感状态
- 回复既有信息确认，也有情感关怀

---

### 场景 C：自我进化（闭环）

**第一次交互**：
```
用户："明天上午10点开会"
Executor：创建事件（10:00-11:00）
```

**Observer 分析**：
```
- 行为：用户选择了上午10点
- 模式：用户偏好上午开会
- 决策：增加规则，confidence = 0.5
```

**第十次类似交互**：
```
用户："周三上午10点开会"
Executor：自动应用规则，直接创建
Observer：confidence 更新到 0.9
```

**进化验证**：
```
用户：（接受）
→ 置信度增加到 0.95
→ 规则变为：默认自动执行
```

---

## 5. 提示词设计原则

### 5.1 通用原则

**原则 1：角色定义优先于行为约束**

❌ 不好的写法：
```
你是 UniLife 助手。
不要使用机械语言。
不要重复相同的话术。
禁止说教用户。
```

✅ 好的写法：
```
你是 UniLife，用户贴心的朋友。
你说话简洁有力，点到为止。
你理解用户的潜台词，用一句话说中要点。
```

**原则 2：Few-Shot 示例胜过抽象描述**

❌ 不好的写法：
```
当用户表达压力时，要表示理解和鼓励。
语气要温暖但不矫情。
```

✅ 好的写法：
```
示例：
用户："最近好累"
你："辛苦了。想聊聊还是休息会儿？"

用户："压力好大"
你："怎么了？是工作还是生活上的？"
```

**原则 3：动态内容单独标注**

❌ 混在提示词中：
```
用户当前时间是：{current_time}
用户决策偏好是：{user_decision}
```

✅ 明确注入：
```
## 动态上下文（系统自动注入）
- 当前时间：{current_time}
- 用户决策偏好：{user_decision}
```

---

### 5.2 Router 提示词设计

**核心目标**：快速准确的路由决策

**关键要素**：
1. **清晰的意图分类**：列出所有可能的意图
2. **路由规则**：什么情况走哪条路
3. **混合意图判断**：如何识别"既要又要"

**决策树（内部逻辑，不需要在 prompt 中写出）**：

```
有明确操作动词 → executor
有情感词汇 + 操作 → both
纯闲聊/情绪 → persona
不确定 → both（更安全）
```

---

### 5.3 Executor 提示词设计

**核心目标**：理性、高效的工具调用

**关键要素**：
1. **默认确认模式**：什么时候可以直接执行
2. **决策偏好遵守**：如何应用用户规则
3. **结果输出格式**：简洁确认

**用户决策偏好的应用优先级**：

```
1. explicit_rules（显式规则）
   - 用户明确说过的 → 必须遵守
   - 例如："周五晚上不排工作"

2. scenario_preferences（场景偏好，高置信度）
   - confidence > 0.8 → 作为默认值
   - confidence 0.5-0.8 → 作为建议选项

3. 默认值
   - 没有任何历史数据时使用
   - 通用、保守的选择
```

---

### 5.4 Persona 提示词设计

**核心目标**：温暖、简洁、像人

**关键要素**：
1. **人格定义**：是什么样的人
2. **语气样本**：如何说话
3. **状态感知**：理解用户当前状态

**回复生成框架**：

```
1. 确认操作结果（如有）
   - "排好了，明天下午3点"
   - "改好了，周三下午4点"

2. 显示查询结果（如有）
   - "明天有两个会议：上午10点和下午3点"
   - "后天是空的，想安排点什么吗？"

3. 纯聊天（响应情感）
   - 理解情绪 + 适当回应
   - "辛苦了" / "怎么了？" / "不错嘛"

4. 需要更多信息
   - 直接问："几点？" / "哪天？"
```

**语气控制公式**：

```
基础语气 = 人格基调
  × 用户状态调整
  × 场景因素

例如：
  基调：轻松幽默
  × 状态：压力大（增加共情）
  × 场景：查询失败（理解 + 建议）
```

---

### 5.5 Observer 提示词设计

**核心目标**：从数据中提取洞察

**关键要素**：
1. **事实提取**：发生了什么
2. **模式识别**：有什么规律
3. **洞察生成**：为什么这样
4. **规则输出**：结构化更新

**分析框架**：

```
[1] 行为分类
   - 时间相关：start_of_day, energy_by_day
   - 决策相关：conflict_resolution
   - 关系相关：relationship_status
   - 情绪相关：emotional_state

[2] 置信度计算
   - 首次发现：0.5
   - 重复确认：+0.1
   - 连续出现：+0.15
   - 长期稳定：+0.2

[3] 规则生成
   - 如果 confidence >= 0.7：作为默认规则
   - 如果 confidence < 0.5：需要更多观察
```

---

## 6. 给提示词工程师的特别说明

### 6.1 Prompt 优化的关键指标

**指标 1：路由准确率**
- Router 是否正确识别意图？
- 混合意图是否走 `both` 路线？

**测试方法**：
- 100 条典型用户消息
- 统计路由决策正确率

**指标 2：默认确认率**
- Executor 有多少次直接执行（不问用户）？
- 用户满意度如何？

**测试方法**：
- 记录 "询问用户" 的频率
- 用户反馈统计

**指标 3：拟人化评分**
- Persona 回复是否自然？
- 是否理解用户情绪状态？

**测试方法**：
- 人工评估回复质量
- 用户满意度评分

---

### 6.2 Prompt 迭代建议

**迭代策略 1：从简单到复杂**

阶段 1：基础功能
- Router 能正确路由
- Executor 能正确调用工具
- Persona 能正常回复

阶段 2：注入画像
- 动态注入用户画像
- 根据状态调整回复

阶段 3：自我进化
- Observer 正确学习
- 画像自动更新

**迭代策略 2：AB 测试**

对不同版本的 Prompt：
- 分别部署，获取用户反馈
- 对比关键指标
- 选择更优版本

---

### 6.3 常见陷阱

**陷阱 1：过度指令化**

❌ 不要：
```
你必须回复"好的"或"没问题"或"收到"。
你不得使用表情符号。
```

✅ 应该：
```
你的回复简洁有力，点到为止。
示例：
用户："排好了"
你："嗯。" 或 "收到"
```

**陷阱 2：负面约束疲劳**

❌ 不要：
```
禁止使用：
- 好的
- 没问题
- 可以的
- OK
```

✅ 应该：
```
你的回复风格：
- 简洁确认："排好了" "改好了"
- 理解情绪："辛苦了" "怎么了？"
- 避免客套话："好的" → "嗯"
```

**陷阱 3：过度解释**

❌ 不要：
```
当用户查询日程时，你应该：
1. 首先向用户问好
2. 告诉用户正在查询
3. 将查询结果展示给用户
4. 询问用户是否还需要其他帮助
```

✅ 应该：
```
查询结果展示示例：
用户："我的日程"
你："明天有两个会议：上午10点和下午3点。"
```

---

### 6.4 Few-Shot 示例的设计原则

**原则 1：代表性**

每个示例应该代表一种典型场景：
- 问候
- 感谢
- 创建事件
- 查询日程
- 压力表达
- 冲突处理

**原则 2：多样性**

涵盖不同的：
- 用户状态（正常/压力/开心）
- 操作类型（创建/查询/修改）
- 回复风格（简洁/共情/幽默）

**原则 3：真实性**

基于真实对话数据，不要编造理想化交互。

---

## 7. 系统自我进化的机制设计

### 7.1 学习闭环

```
交互数据 → Observer 分析 → 规则生成
    ↓                           ↓
  应用规则 ←─── 验证结果 ←───────┘
```

### 7.2 置信度更新算法

**累积模式**：
```
confidence = base + (α × sample_count)

base = 0.5 (初始值)
α = 0.05 (每次增加的置信度)

// 示例
第1次：confidence = 0.5 + 0.05 = 0.55
第2次：confidence = 0.5 + 0.05×2 = 0.60
...
第10次：confidence = 0.5 + 0.05×10 = 1.0 (封顶)
```

**冲突处理**：
```
观察到行为A，置信度0.6
观察到行为B（与A冲突），置信度0.3

→ A的置信度降低：0.6 - 0.3 = 0.3
→ B的置信度上升：0.3 + 0.1 = 0.4
```

### 7.3 规则生命周期

```
[0.0, 0.3)  → 观察期（模式尚不稳定）
[0.3, 0.7)  → 试用期（可以作为建议）
[0.7, 0.9)  → 信任期（可以作为默认）
[0.9, 1.0]  → 自动期（可以直接执行）
```

---

## 8. 微调与评估指南

### 8.1 微调目标

**Agent 特定的微调目标**：

| Agent | 微调目标 |
|-------|---------|
| Router | 意图分类准确率 > 95% |
| Executor | 工具调用正确率 > 90% |
| Persona | 人格一致性评分 > 4/5 |
| Observer | 模式识别准确率 > 80% |

### 8.2 评估数据集

**数据集划分**：
- 训练集：真实用户对话（去标识化）
- 验证集：人工标注的场景
- 测试集：未见过的新场景

**标注维度**：
1. 意图分类（Router）
2. 工具调用正确性（Executor）
3. 人格一致性（Persona）

### 8.3 评估指标

**Router 评估**：
- Precision/Recall/F1 for intent classification
- Routing accuracy

**Executor 评估**：
- Tool selection accuracy
- Parameter correctness
- Decision quality（人工评估）

**Persona 评估**：
- Human-likeness score（人工评分）
- Emotional intelligence
- Consistency with persona

---

## 9. 未来扩展方向

### 9.1 短期（1-3个月）

- [ ] 完善用户画像表的自动化创建
- [ ] 添加更多 Few-Shot 示例
- [ ] 优化 Observer 的学习算法
- [ ] A/B 测试不同 Prompt 版本

### 9.2 中期（3-6个月）

- [ ] 实现 Planner Agent（复杂任务规划）
- [ ] 添加 Memory Agent（长期记忆管理）
- [ ] 支持多轮任务规划
- [ ] 添加用户反馈循环

### 9.3 长期（6个月+）

- [ ] 小模型微调（降低成本和延迟）
- [ ] 多模态输入（语音、图片）
- [ ] 跨对话上下文学习
- [ ] 用户画像跨会话迁移

---

## 10. 给 AI 开发者的实践建议

### 10.1 Prompt 调试流程

```
1. 设计基础 Prompt
   ↓
2. 单元测试（验证核心功能）
   ↓
3. 集成测试（验证交互流程）
   ↓
4. 用户测试（收集反馈）
   ↓
5. 数据分析 → 优化 Prompt
```

### 10.2 日志分析要点

**关键日志**：
```
[Router] 意图: create_event, 路由: executor, 置信度: 0.95
[Executor] 已创建事件：明天下午3点开会（60分钟）
[Persona] 回复：排好了，明天下午3点。
[Observer] 提取信号：preference=gym_time, confidence=0.7
```

**分析重点**：
- Router 是否误判？
- Executor 是否遵守了用户规则？
- Persona 是否理解了用户情绪？
- Observer 是否在学习正确的模式？

### 10.3 A/B 测试框架

```
版本 A：当前版本
版本 B：新优化版本

分流比例：50/50

观察指标：
- 用户满意度
- 任务完成率
- 对话轮次（越少越好）
```

---

**文档版本**: 2.0
**最后更新**: 2026-01-23
**维护者**: UniLife 团队
